name: Deploy to GCP
#on:
#    push:
#        branches:
#            - master
on: workflow_dispatch
jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [16.x]
                go-version: [~1.19]
        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Use Go ${{ matrix.go-version }}
              uses: actions/setup-go@v2
              with:
                  go-version: ${{ matrix.go-version }}
              id: go
            - name: Cache ~/.npm
              uses: actions/cache@v2
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - name: Install npm Dependencies
              run: npm ci
            - name: Cache ./node_modules/.cache for nx usage
              uses: actions/cache@v2
              with:
                  path: ./node_modules/.cache
                  key: ${{ runner.os }}-${{ matrix.node-version }}-node-cache-${{ hashFiles('./*.json') }}-${{ github.ref }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.node-version }}-node-cache-${{ hashFiles('./*.json') }}
                      ${{ runner.os }}-${{ matrix.node-version }}-node-cache-
            - name: Cache Go modules
              uses: actions/cache@v2
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-
            - name: Run Build all resources
              shell: bash
              run: npm run build-all
            - name: Build image
              run: npm run nx -- build-image platform
            - name: Setup GCP Service Account
              uses: google-github-actions/setup-gcloud@master
              with:
                  version: "latest"
                  service_account_email: ${{ secrets.GCP_SA_EMAIL }}
                  service_account_key: ${{ secrets.GCP_SA_KEY }}
                  export_default_credentials: true
            - name: Configure Docker
              run: |
                  gcloud auth configure-docker ${{ secrets.GCP_ARTIFACT_REGISTRY_HOST }}
            - name: Build
              run: |
                  docker tag uesio:latest ${{ secrets.GCP_ARTIFACT_REGISTRY_HOST }}/${{ secrets.GCP_PROJECT_ID }}/uesio/uesio:latest
            - name: Push
              run: |
                  docker push ${{ secrets.GCP_ARTIFACT_REGISTRY_HOST }}/${{ secrets.GCP_PROJECT_ID }}/uesio/uesio:latest
