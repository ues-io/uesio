name: Build and Test
on:
    push:
jobs:
    build:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [16.x]
                go-version: [^1.19]
        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Use Go ${{ matrix.go-version }}
              uses: actions/setup-go@v2
              with:
                  go-version: ${{ matrix.go-version }}
              id: go
            - name: Cache ~/.npm
              uses: actions/cache@v2
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-${{ matrix.node-version }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.node-version }}-node-
            - name: Install npm Dependencies
              run: npm ci
            - name: Cache ./node_modules/.cache for nx usage
              uses: actions/cache@v2
              with:
                  path: ./node_modules/.cache
                  key: ${{ runner.os }}-${{ matrix.node-version }}-node-cache-${{ hashFiles('./*.json') }}-${{ github.ref }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.node-version }}-node-cache-${{ hashFiles('./*.json') }}
                      ${{ runner.os }}-${{ matrix.node-version }}-node-cache-
            - name: Cache Go modules
              uses: actions/cache@v2
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-
            - name: Run Affected Tests
              shell: bash
              run: |
                  npm run prettier-check
                  npm run affected:lint -- --base=origin/master --head=$GITHUB_SHA --parallel
                  npm run build-all
                  npm run affected:test -- --base=origin/master --head=$GITHUB_SHA --parallel
                  npm run affected:e2e -- --base=origin/master --head=$GITHUB_SHA --parallel
