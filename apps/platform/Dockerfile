FROM golang:1.19-alpine AS multistage

WORKDIR /src
COPY ./apps/platform .
RUN \
    --mount=type=cache,target=$GOPATH \
    go install
RUN go build

##

FROM alpine:latest
COPY --from=multistage /src/uesio .
COPY ./apps/platform/fonts ./fonts
COPY ./apps/platform/seed ./seed
COPY ./libs/apps ./libs/apps
COPY ./apps/platform/platform ./platform
COPY ./dist ./dist

ENV GITSHA=""

EXPOSE 3000

CMD ["./uesio", "serve"]
